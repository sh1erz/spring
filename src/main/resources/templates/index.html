<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Main</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/css/bootstrap.min.css">
</head>
<body style="margin: 0;">
<header th:replace="fragments/header.html :: header"></header>
<h2>Categories</h2>
<div class="row-cols-1">
    <button th:each="category : ${root_categories}" th:id="${category.id}"
            th:text="${category.name}" th:onclick="|showSub(${category.id})|"
            data-toggle="collapse" aria-expanded="false" type="button"  class="btn btn-primary"></button>
</div>

<script th:inline="javascript" type="text/javascript">
    function showSub(categoryId) {
        $.get({
            url: /*[[ @{/ajax/getCategory} ]]*/ null,
            dataType: 'json',
            data: {id: categoryId}
        }).then(function (rootCategory) {
            let rootElem = document.getElementById(categoryId)
            rootElem.removeAttribute("onclick")
            let group = document.createElement("div")
            group.setAttribute("id", "group_" + categoryId)
            rootElem.after(group)
            for (let i = 0; i < rootCategory.categories.length; i++) {
                let subCategory = rootCategory.categories[i]
                initSubCategories(subCategory,group)
                //group.append(subElem)
            }
            rootElem.setAttribute("aria-controls", "group_" + rootCategory.id)
            rootElem.setAttribute("data-target", "#group_" + rootCategory.id)
            /*const categoryDiv = document.getElementById(categoryId)
            //remove Submenu for categoryEntity button
            categoryDiv.firstElementChild.setAttribute("onclick", "removeSubmenu(" + categoryId + ")")

            const subCategoriesDiv = document.createElement("div");
            subCategoriesDiv.setAttribute("id", categoryId + "_sub")
            categoryDiv.append(subCategoriesDiv)

            for (let i = 0; i < category.categories.length; i++) {
                let subcategory = category.categories[i]
                const div = document.createElement("div")
                const b = document.createElement("button")
                b.innerHTML = subcategory.name
                setStyles(categoryDiv, div)
                subCategoriesDiv.appendChild(div)
                div.setAttribute("id", subcategory.id)
                div.appendChild(b)

                if (subcategory.categories.length <= 0) {
                    //if its end category
                    b.setAttribute("onclick", "location.href='http://localhost:8080/products?id="
                        + subcategory.id + "';")
                }else {
                    b.setAttribute("onclick", "makeSubmenu(" + subcategory.id + ")")

                }
            }*/
        });
    }

    //return subCategory id
    function initSubCategories(category, previousGroup) {
        const categoryElem = document.createElement("button")
        categoryElem.setAttribute("id", category.id)
        categoryElem.innerHTML = category.name
        previousGroup.append(categoryElem)
        //if no more subcategories
        if (category.categories.length <= 0) {
            categoryElem.setAttribute("class", "btn btn-secondary")
            categoryElem.setAttribute("onclick", "location.href='http://localhost:8080/products?id="
                + category.id + "';")
            return categoryElem
        }
        //if there is more
        setCollapsableAttrs(categoryElem)

        let group = document.createElement("div")
        group.setAttribute("id", "group_" + category.id)
        group.setAttribute("class","collapse")
        previousGroup.append(group)
        for (let i = 0; i < category.categories.length; i++) {
            let subCategory = category.categories[i]
            let subElem = initSubCategories(subCategory,group)
            group.append(subElem)
        }
        categoryElem.setAttribute("aria-controls", "group_" + category.id)
        categoryElem.setAttribute("data-target", "#group_" + category.id)
        return categoryElem
    }

    function setCollapsableAttrs(b) {
        b.setAttribute("class", "btn btn-primary")
        b.setAttribute("data-toggle", "collapse")
        b.setAttribute("aria-expanded", "false")
        b.setAttribute("type", "button")
    }
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"></script>
</body>
</html>